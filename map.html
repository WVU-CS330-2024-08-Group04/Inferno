<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Map Page</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="mapStyles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            color: black;
            background-color: white;
            transition: background-color 0.5s, color 0.5s;
        }
        .dark-mode {
            background-color: black;
            color: white;
            transition: background-color 0.5s, color 0.5s;
        }
        .center {
            text-align: center;
            margin-top: 50px;
        }
        button{
            cursor: pointer;
            color: black; 
            transition: background-color 0.5s, color 0.5s;
        }
    </style>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Esri Leaflet JavaScript -->
    <script src="https://unpkg.com/esri-leaflet@3.0.5/dist/esri-leaflet.js"></script>
</head>

<body>
    <!-- Start of banner -->
    <div class="banner">
        <div class="banner-back">
            <a href="welcome.html">
                <img src="Inferno wildfire full logo cropped.png" alt="logo" />
            </a>
        </div>
        <input type="image" src="Profile Icon.png" onclick="location.href='accountSettings.html'" class="user-icon" />
        <a href="about.html" class="about-link">About</a>
        <button id="clickMe" onclick="darkMode()" class="dark-button">
            <span id="clickMeText">Dark Mode</span>
            <span class="button_icon">
                <ion-icon name="moon"></ion-icon>
            </span>
        </button>
        <div class="helloName" id="helloName"></div>
    </div>
    <!-- End of banner -->

    <div class="search-container">
        <input type="text" class="search-bar" id="locationInput" placeholder="Search a location..." />
        <button class="search-button" onclick="searchLocation()">Search</button>
        <button id="saveLocationBtn" style="display: none;" onclick="saveLocation()">Save Location</button>

        <!-- Dropdown for Saved Locations -->
        <label for="savedLocations">Saved Locations:</label>
        <select id="savedLocations" onchange="jumpToSavedLocation()">
            <option value="">--Select a saved location--</option>
        </select>
    </div>
    <!-- Map section -->
    <div id="map" style="width:80%; height: 600px;"></div>
    <!-- Toggle for DEM Layer -->
    <div>
        <input type="checkbox" id="toggleDEM" checked>
        <label for="toggleDEM">Legend Layer</label>
    </div>

    <!-- Side buttons -->
    <div class="side-buttons">
        <a href="welcome.html"><button>Home</button></a>
        <a href="accountSettings.html"><button>Account</button></a>

        <!-- Date range selection -->
        <div class="date-container">
            <label for="startDate">Start Date:</label>
            <input type="date" id="startDate"><br>

            <label for="endDate">End Date:</label>
            <input type="date" id="endDate">
            <button onclick="getDates()">Select Time Range</button>

            <div id="selected-dates"></div>
        </div>
        <button class="dropdown-trigger">Filters</button>
        <div class="dropdown-content">
            <label><input type="checkbox" name="Smoke" value="Smoke"> Smoke</label><br>
            <label><input type="checkbox" name="Active Fires" value="Active Fires"> Active Fires</label><br>
            <label><input type="checkbox" name="Fire Prediction" value="Fire Prediction"> Fire Prediction</label><br>
            <label><input type="checkbox" name="Elevation" value="Elevation">Elevation</label><br>
            <button class="apply-filters">Apply Filters</button>
        </div>
        <div id="selected-filters"></div>
    </div>

    <script>
        // Dropdown filter logic
        const dropdownTrigger = document.querySelector('.dropdown-trigger');
        const dropdownContent = document.querySelector('.dropdown-content');
        dropdownContent.style.display = 'none';

        dropdownTrigger.addEventListener('click', function () {
            dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
            dropdownContent.style.textAlign = "left";
        });

        // Close dropdown if clicked outside
        document.addEventListener('click', function (event) {
            if (!dropdownTrigger.contains(event.target) && !dropdownContent.contains(event.target)) {
                dropdownContent.style.display = 'none';
            }
        });

        // Get selected filters
        function getFilters() {
            const checkboxes = document.querySelectorAll('.dropdown-content input[type="checkbox"]');
            const selectedFilters = Array.from(checkboxes).filter(checkbox => checkbox.checked).map(checkbox => checkbox.value);
            console.log(selectedFilters);
        }

        // Apply filters button
        const applyButton = dropdownContent.querySelector('button');
        applyButton.addEventListener('click', function () {
            getFilters();
            dropdownContent.style.display = 'none'; // Close dropdown after applying filters
        });
        document.addEventListener("DOMContentLoaded", function () {
            const darkModeEnabled = localStorage.getItem("darkMode") === "enabled";
            if (darkModeEnabled) {
                document.body.classList.add("dark-mode");
                setDarkModeUI(true);
            }
        });

        function darkMode() {
            var element = document.body;
            element.classList.toggle("dark-mode");

            const darkModeEnabled = element.classList.contains("dark-mode");
            setDarkModeUI(darkModeEnabled);

            localStorage.setItem("darkMode", darkModeEnabled ? "enabled" : "disabled");
        }

        function setDarkModeUI(isDarkMode) {
            var img = document.getElementById("image");
            var clickMeText = document.getElementById("clickMeText");
            var buttonIcon = document.querySelector(".button_icon ion-icon");

            if (isDarkMode) {
                img.src = "Dark Mode Inferno Full Logo cropped.png";
                clickMeText.textContent = "Light Mode";
                buttonIcon.setAttribute("name", "sunny");
            } else {
                img.src = "Inferno wildfire full logo cropped.png";
                clickMeText.textContent = "Dark Mode";
                buttonIcon.setAttribute("name", "moon");
            }
        }

        // Initialize map (only one instance)
        var map = L.map('map').setView([39.8283, -98.5795], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // Add the DEM layer
        const demLayer = L.tileLayer.wms("https://elevation.nationalmap.gov/arcgis/services/3DEPElevation/ImageServer/WMSServer?", {
            layers: "3DEPElevation:Hillshade Elevation Tinted",
            format: "image/png",
            transparent: true,
            opacity: 0.7
        });

        // Add the DEM layer to the map initially if checked
        if (document.getElementById('toggleDEM').checked) {
            demLayer.addTo(map);
        }

        // Toggle the DEM layer on checkbox change
        document.getElementById('toggleDEM').addEventListener('change', function () {
            if (this.checked) {
                demLayer.addTo(map); // Add layer if checkbox is checked
            } else {
                map.removeLayer(demLayer); // Remove layer if checkbox is unchecked
            }
        });
      
        var legend = L.control({position: 'bottomleft'});

legend.onAdd = function (map) {

var div = L.DomUtil.create('div', 'info legend');

div.innerHTML += '<strong>Chance of Fire<strong><br>'
    div.innerHTML += '<i style = "background:#E30808;"></i>High Chance<strong><br>'
    div.innerHTML += '<i style = "background:#FAA064;"></i>Moderate Chance<strong><br>'
    div.innerHTML += '<i style = "background:#F0E300;"></i>Low Chance<strong><br>'
    div.innerHTML += '<i style = "background:#26C454;"></i>No Chance<strong><br>'
return div;
};

legend.addTo(map);


        // Other functionalities: Search location, save location, etc.
        var currentMarker;
        var savedLocations = [];
        var lastSearchedLocation;

        function searchLocation() {
            var location = document.getElementById('locationInput').value;
            var geocodeURL = 'https://nominatim.openstreetmap.org/search?format=json&q=' + location;

            fetch(geocodeURL)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        var lat = data[0].lat;
                        var lon = data[0].lon;
                        var displayName = data[0].display_name;

                        map.setView([lat, lon], 13);

                        if (currentMarker) {
                            map.removeLayer(currentMarker);
                        }

                        currentMarker = L.marker([lat, lon]).addTo(map)
                            .bindPopup(displayName)
                            .openPopup();

                        lastSearchedLocation = {
                            name: displayName,
                            lat: lat,
                            lon: lon
                        };

                        document.getElementById('saveLocationBtn').style.display = 'inline';
                    } else {
                        alert("Location not found. Please try again.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching location data:", error);
                });
        }

        document.getElementById('locationInput').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                searchLocation();
            }
        });
        
       

        function saveLocation() {
            if (lastSearchedLocation) {
                var name = lastSearchedLocation.name;
                var lat = lastSearchedLocation.lat;
                var lon = lastSearchedLocation.lon;

                if (!savedLocations.some(loc => loc.name === name)) {
                    savedLocations.push({ name: name, lat: lat, lon: lon });

                    var dropdown = document.getElementById('savedLocations');
                    var option = document.createElement('option');
                    option.text = name;
                    option.value = JSON.stringify({ lat: lat, lon: lon });
                    dropdown.add(option);

                    document.getElementById('saveLocationBtn').style.display = 'none';
                } else {
                    alert("Location is already saved.");
                }
            }
        }

        function jumpToSavedLocation() {
            var dropdown = document.getElementById('savedLocations');
            var selectedValue = dropdown.value;

            if (selectedValue) {
                var location = JSON.parse(selectedValue);
                var lat = location.lat;
                var lon = location.lon;

                map.setView([lat, lon], 13);

                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }

                currentMarker = L.marker([lat, lon]).addTo(map)
                    .bindPopup(dropdown.options[dropdown.selectedIndex].text)
                    .openPopup();
            }
        }

        function getDates() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (startDate && endDate) {
                document.getElementById('selected-dates').innerText = `Selected Dates: ${startDate} to ${endDate}`;
            }
        }

        
        

    </script>
     <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
     <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</body>

</html>